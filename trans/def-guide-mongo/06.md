# 六、PHP 和 MongoDB

Abstract

通过前五章，您已经学习了如何在 MongoDB shell 中执行各种操作。例如，您已经学习了如何添加、修改和删除文档。您还了解了 DBRef 和 GridFS 的工作方式，包括如何使用它们。

通过前五章，您已经学习了如何在 MongoDB shell 中执行各种操作。例如，您已经学习了如何添加、修改和删除文档。您还了解了 DBRef 和 GridFS 的工作方式，包括如何使用它们。

然而，到目前为止，您所了解的大多数事情都发生在 MongoDB shell 中。这是一个非常强大的应用，但是 MongoDB 软件还附带了大量的额外驱动程序(参见[第 2 章](02.html)了解更多相关信息),这些驱动程序允许您跳出Shell，以编程方式完成许多其他类型的任务。

其中一个工具是 PHP 驱动程序，当您想使用 PHP 而不是 shell 时，它允许您扩展 PHP 安装来连接、修改和管理 MongoDB 数据库。当您需要设计一个 web 应用，或者没有访问 MongoDB shell 的权限时，这可能会很有帮助。正如本章将要演示的，您可以用 PHP 驱动程序执行的大多数操作与您可以在 MongoDB shell 中执行的功能非常相似；然而，PHP 驱动程序要求在一个数组中指定选项，而不是在两个花括号之间。尽管有相似之处，但是在使用 PHP 驱动程序时，你需要注意一些细节。这一章将带您了解在 MongoDB 中使用 PHP 的好处，以及如何克服前面提到的“无论如何”

这一章在许多方面把你带回到起点。您将从学习在 PHP 中导航数据库和使用集合开始。接下来，您将学习如何在 PHP 中插入、修改和删除帖子。您还将学习如何再次使用 GridFS 和 DBRef 然而，这一次，重点将是如何在 PHP 中使用它们，而不是这些技术背后的理论。

## 比较 MongoDB 和 PHP 中的文档

正如您之前所了解的，MongoDB 集合中的文档是使用类似 JSON 的格式存储的，该格式由键和值组成。这类似于 PHP 定义关联数组的方式，所以习惯这种格式应该不会太难。

例如，假设一个文档在 MongoDB shell 中如下所示:

`contact = ( {`

`"First Name" : "Philip"`，

`"Last Name" : "Moran"`，

`"Address" : [`

`{`

`"Street" : "681 Hinkle Lake Road"`，

`"Place" : "Newton"`，

`"Postal Code" : "MA 02160"`，

`"Country" : "USA"`

`}`

`]`，

`"E-Mail" : [`

`"` `pm@example.com` `"`，

`"` `pm@office.com` `"`，

`"` `philip@example.com` `"`，

`"` `philip@office.com` `"`，

`"` `moran@example.com` `"`，

`"` `moran@office.com` `"`，

`"` `pmoran@example.com` `"`，

`"``pmoran@office.com`T2】

`]`，

`"Phone" : "617-546-8428"`，

`"Age" : 60`

`})`

当包含在 PHP 的一个数组中时，同一个文档看起来像这样:

`$contact = array(`

`"First Name" => "Philip"`，

`"Last Name" => "Moran"`，

`"Address" => array(`

`"Street" => "681 Hinkle Lake Road"`，

`"Place" => "Newton"`，

`"Postal Code" => "MA 02160"`，

`"Country" => "USA"`

`)`

,

`"E-Mail" => array(`

`"` `pm@example.com` `"`，

`"` `pm@office.com` `"`，

`"` `philip@example.com` `"`，

`"` `philip@office.com` `"`，

`"` `moran@example.com` `"`，

`"` `moran@office.com` `"`，

`"` `pmoran@example.com` `"`，

`"``pmoran@office.com`T2】

`)`，

`"Phone" => "617-546-8428"`，

`"Age" => 60`

`);`

这份文件的两个版本看起来很相似。明显的区别是，在 PHP 中，冒号(:)作为键/值分隔符被一个类似箭头的符号(= >)所取代。你会很快习惯这些句法上的差异。

## 蒙戈布班

MongoDB 的 PHP 驱动程序包含四个核心类，几个用于处理 GridFS 的类，还有几个用于表示 MongoDB 数据类型的类。核心类构成了驱动程序最重要的部分。总之，这些类允许您执行一组丰富的命令。可用的四个核心类如下:

*   `MongoClient`:向数据库发起，提供`connect()`、`close()`、`listDBs()`、`selectDBs()`、`selectCollection()`等数据库服务器命令。
*   `MongoDB`:与数据库交互，提供`createCollection()`、`selectCollection()`、`createDBRef()`、`getDBRef()`、`drop()`、`getGridFS()`等命令。
*   `MongoCollection`:与收藏互动。包括`count()`、`find()`、`findOne()`、`insert()`、`remove()`、`save()`、`update()`等命令。
*   `MongoCursor`:与`find()`命令返回的结果进行交互，包括`getNext()`、`count()`、`hint()`、`limit()`、`skip()`、`sort()`等命令。

在这一章中，我们将看看所有前面的命令；毫无疑问，您将最常使用这些命令。

Note

本章将不讨论前面按类分组的命令；相反，这些命令将尽可能按照逻辑顺序进行排序。

## 连接和断开

让我们从研究如何使用 MongoDB 驱动程序来连接和选择数据库和集合开始。使用`Mongo`类建立连接，该类也用于数据库服务器命令。以下示例显示了如何在 PHP 中快速连接到数据库:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the database you want to connect to, e.g` `contacts`

`$c->contacts;`

`Mongo`类还包括`selectDB()`函数，您可以使用它来选择数据库:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the database you want to connect to, e.g.` `contacts`

`$c->selectDB("contacts");`

下一个示例显示了如何选择要使用的集合。与在 shell 中工作时应用的规则相同:如果您选择了一个尚不存在的集合，那么当您将数据保存到其中时，将会创建该集合。选择要连接的集合的过程类似于连接到数据库的过程；换句话说，您使用(`->`)语法直接指向相关的集合，如下例所示:

`// Connect to the database`

`$c = new Mongo();`

`// Selecting the database ('contacts') and collection ('people') you want`

`// to connect to`

`$c->contacts->people;`

`selectCollection()`功能还允许您选择或切换收藏，如下例所示:

`// Connect to the database`

`$c = new Mongo();`

`// Selecting the database ('contacts') and collection ('people') you want`

`// to connect to`

`$c-> selectDB("contacts")->selectCollection("people");`

在选择数据库或集合之前，有时需要找到所需的数据库或集合。`Mongo`类包括两个附加命令，用于列出可用的数据库以及可用的集合。您可以通过调用`listDBs()`函数并打印输出(将放在一个数组中)来获取可用数据库的列表:

`// Connecting to the database`

`$c = new Mongo();`

`// Listing the available databases`

`print_r($c->listDBs());`

同样，您可以使用`listCollections()`来获得数据库中可用集合的列表:

`// Connecting to the database`

`$c = new Mongo();`

`// Listing the available collections within the 'contacts' database`

`print_r($c->contacts->listCollections());`

Note

本例中使用的`print_r`命令是一个打印数组内容的 PHP 命令。`listDBs()`函数直接返回一个数组，所以该命令可以作为`print_r`函数的参数。

`MongoClient`类还包含一个`close()`函数，可以用来断开 PHP 会话与数据库服务器的连接。然而，通常不需要使用它，除非在不寻常的情况下，因为只要`Mongo`对象超出范围，驱动程序就会自动干净地关闭到数据库的连接。

有时您可能不想强行关闭连接。例如，您可能不确定连接的实际状态，或者您可能希望确保可以建立新的连接。在这种情况下，可以使用`close()`函数，如下例所示:

`// Connecting to the database`

`$c = new Mongo();`

`// Closing the connection`

`$c->close();`

## 插入数据

到目前为止，您已经看到了如何建立到数据库的连接。现在是时候学习如何将数据插入到您的集合中了。在 PHP 中这样做的过程与使用 MongoDB shell 时没有什么不同。该过程有两个步骤。首先，在变量中定义文档。其次，使用`insert()`函数插入它。

定义文档并不特别与 MongoDB 相关，而是创建一个存储了键和值的数组，如下例所示:

`$contact = array(`

`"First Name" => "Philip"`，

`"Last Name" => "Moran"`，

`"Address" => array(`

`"Street" => "681 Hinkle Lake Road"`，

`"Place" => "Newton"`，

`"Postal Code" => "MA 02160"`，

`"Country" => "USA"`

`)`

,

`"E-Mail" => array(`

`"` `pm@example.com` `"`，

`"` `pm@office.com` `"`，

`"` `philip@example.com` `"`，

`"` `philip@office.com` `"`，

`"` `moran@example.com` `"`，

`"` `moran@office.com` `"`，

`"` `pmoran@example.com` `"`，

`"``pmoran@office.com`T2】

`)`，

`"Phone" => "617-546-8428"`，

`"Age" => 60`

`);`

Warning

发送到数据库的字符串需要采用 UTF-8 格式，以防止出现异常。

一旦您将数据正确地赋给了一个变量——在本例中称为`$contact`——您就可以使用`insert()`函数将其插入到`MongoCollection`类中:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people'`

`$collection = $c->contacts->people;`

`// Insert the document '$contact' into the people collection '$collection'`

`$collection->insert($contact);`

`insert()`函数有五个选项，在一个数组中指定:`fsync, j, w, wtimeout`和`timeout`。`fsync`选项可以设置为`TRUE`或`FALSE`；`FALSE`是该选项的默认值。如果设置为`TRUE`，`fsync`在指示插入成功之前，强制将数据写入硬盘。该选项将覆盖选项`w`的任何设置，将其设置为 0。`j`选项可以设置为`TRUE`或`FALSE`，默认为`FALSE`。如果设置，`j`选项将在指示插入成功之前强制将数据写入日志。如果您不熟悉日志记录，可以把它想象成一个日志文件，在数据最终写入磁盘之前，记录对数据所做的更改。这确保了如果`mongod`意外停止，它将能够恢复写入日志的更改，从而防止您的数据进入不一致状态。

`w`选项可用于确认或不确认写操作(使该选项也适用于`remove()`和`update()`操作)。如果`w`置 0，写操作将不被确认；将其设置为 1，写操作将被(主)服务器确认。当使用副本集时，`w`也可以设置为`n`，确保主服务器在成功复制到`n`节点时确认写操作。`w`也可以设置为`'majority'`—一个保留字符串—确保大多数副本集将确认写入，或者设置为一个特定的标记，确保那些标记的节点将确认写入。对于此选项，默认设置也是 1。`wtimeout`选项可用于指定服务器等待接收确认的时间(以毫秒为单位)。默认情况下，该选项设置为 10000。最后，`timeout`选项允许您指定客户机需要等待数据库响应多长时间(毫秒)。

以下示例说明了如何使用`w and wtimeout`选项插入数据:

`// Define another contact`

`$contact = array(`

`"Fir't Name" => "Victoria"`，

`"Last Name" => "Wood"`，

`"Address" => array(`

`"Street" => "50 Ash lane"`，

`"Place" => "Ystradgynlais"`，

`"Postal Code" => "SA9 6XS"`，

`"Country" => "UK"`

`)`

,

`"E-Mail" => array(`

`"` `vw@example.com` `"`，

`"``vw@office.com`T2】

`)`，

`"Phone" => "078-8727-8049"`，

`"Age" => 28`

`);`

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people'`

`$collection = $c->contacts->people;`

`// Specify the w and wtimeout options`

`$options = array("w" => 1, "wtimeout" => 5000);`

`// Insert the document '$contact' into the people collection '$collection'`

`$collection->insert($contact,$options);`

这就是用 PHP 驱动程序将数据插入数据库的全部内容。在大多数情况下，您可能会定义包含数据的数组，而不是将数据注入数组。

## 列出您的数据

通常，您将使用`find()`函数来查询数据。它使用一个参数来指定您的搜索条件；一旦指定了标准，就执行`find()`来获得结果。默认情况下，`find()`函数只是返回集合中的所有文档。这类似于在[第 4 章](04.html)中讨论的 shell 示例。然而，大多数时候，你并不想这样做。相反，您会希望定义特定的信息来返回结果。接下来的部分将涵盖常用的选项和参数，您可以使用`find()`功能来过滤您的结果。

### 返回单个文档

列出单个文档很容易:只需执行没有指定任何参数的`findOne()`函数，就可以获取它在集合中找到的第一个文档。`findOne`函数将返回的信息存储在一个数组中，让您再次打印出来，如下例所示:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Find the very first document within the collection, and print it out`

`// using print_r`

`print_r($collection->findOne());`

如前所述，在集合中列出单个文档很容易:您需要做的就是定义`findOne()`函数本身。当然，您可以使用带有附加过滤器的`findOne()`函数。例如，如果你知道你要找的人的姓，你可以在`findOne()`函数中指定一个选项:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Define the last name of the person in the $lastname variable`

`$lastname = array("Last Name" => "Moran");`

`// Find the very first person in the collection with the last name "Moran"`

`print_r($collection->findOne($lastname));`

当然，过滤数据还有更多的选择；在本章的后面，您将了解更多关于这些附加选项的信息。让我们从查看使用`print_r()`命令返回的一些示例输出开始(为了使代码更容易阅读，该示例添加了一些换行符):

`Array (`

`[_id] => MongoId Object ( )`

`[First Name] => Philip`

`[Last Name] => Moran`

`[Address] => Array (`

`[Street] => 681 Hinkle Lake Road`

`[Place] => Newton`

`[Postal Code] => MA 02160`

`[Country] => USA`

`)`

`[E-Mail] => Array (`

`[0] =>` `pm@example.com`

`[1] =>` `pm@office.com`

`[2] =>` `philip@example.com`

`[3] =>` `philip@office.com`

`[4] =>` `moran@example.com`

`[5] =>` `moran@office.com`

`[6] =>` `pmoran@example.com`

`[7] =>` `pmoran@office.com`

`)`

`[Phone] => 617-546-8428`

`[Age] => 60`

`)`

### 列出所有文档

虽然您可以使用`findOne()`函数来列出单个文档，但是您将使用`find()`函数来处理几乎所有其他事情。请不要误会:通过限制你的结果，可以找到带有`find()`功能的单个文档；但是如果您不确定要返回的文档数量，或者如果您期望不止一个文档，那么`find()`函数是您的好朋友。

如前几章所述，`find()`函数有很多很多选项，您可以使用这些选项来过滤您的结果，以适应您能想象到的任何情况。我们将从几个简单的例子开始，并以此为基础进行构建。

首先，让我们看看如何使用 PHP 和`find()`函数显示某个集合中的所有文档。在打印多个文档时，唯一需要注意的是每个文档都以数组的形式返回，并且每个数组都需要单独打印。您可以使用 PHP 的`while()`函数来完成这项工作。如前所述，您需要指示函数在处理下一个文档之前打印每个文档。`getNext()`命令从 MongoDB 获取光标中的下一个文档；该命令有效地返回光标中的下一个对象，并向前移动光标。以下代码片段列出了集合中的所有文档:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find();`

`// For each document it finds within the collection, print the contents`

`while ($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

Note

您可以用几种不同的方式实现前面示例的语法。例如，执行前面的命令的一种更快的方式如下:`$cursor = $c->contacts->people->find()`。然而，为了清楚起见，像这样的代码示例将在本章中分成两行，为注释留出更多空间。

在这个阶段，结果输出仍然只显示两个数组，假设您已经添加了本章前面描述的文档(没有其他内容)。如果您要添加更多的文档，那么每个文档都将以自己的数组打印。当然，这看起来不太好；然而，只要增加一点代码，就没什么不能解决的。

### 使用查询运算符

无论您在 MongoDB shell 中能做什么，您也可以使用 PHP 驱动程序来完成。正如您在前面的章节中看到的，shell 包含了几十个过滤结果的选项。例如，可以使用点符号；对结果进行排序或限制；跳过、计数或分组一些项目。或者甚至使用正则表达式等等。下面几节将带您了解如何在 PHP 驱动程序中使用这些选项。

### 查询特定信息

您可能还记得第 4 章中的内容，您可以使用点符号来查询文档中嵌入对象的特定信息。例如，如果您想查找某个您知道部分地址详细信息的联系人，您可以使用点符号来查找，如下例所示:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Use dot notation to search for a document in which the place`

`// is set to "Newton"`

`$address = array("Address.Place" => "Newton");`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($address);`

`// For each document it finds within the collection, print the ID`

`// and its contents`

`while ($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

以类似的方式，您可以通过指定文档数组中的一项(如电子邮件地址)来搜索该数组中的信息。因为电子邮件地址(通常)是唯一的，所以在这个例子中使用`findOne()`函数就足够了:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Define the e-mail address you want to search for under $email`

`$email = array("E-Mail" => "``vw@example.com`T2】

`// Find the very first person in the collection matching the e-mail address`

`print_r($collection->findOne($email));`

正如所料，这个例子返回第一个匹配电子邮件地址`vw@example.com`的文档，在这个例子中是维多利亚·伍德的地址。文档以数组的形式返回:

`Array (`

`[_id] => MongoId Object ( )`

`[First Name] => Victoria`

`[Last Name] => Wood`

`[Address] => Array (`

`[Street] => 50 Ash lane`

`[Place] => Ystradgynlais`

`[Postal Code] => SA9 6XS`

`[Country] => UK`

`)`

`[E-Mail] => Array (`

`[0] =>` `vw@example.com`

`[1] =>` `vw@office.com`

`)`

`[Phone] => 078-8727-8049`

`[Age] => 28`

`)`

### 排序、限制和跳过项目

`MongoCursor`类提供了`sort()`、`limit()`和`skip()`函数，分别允许您对结果进行排序、限制返回结果的总数以及跳过特定数量的结果。让我们使用 PHP 驱动程序来检查每个函数以及它是如何使用的。

PHP 的`sort()`函数将一个数组作为参数。在该数组中，您可以指定对文档进行排序所依据的字段。与使用 shell 时一样，使用值`1`对结果进行升序排序，使用`-1`对结果进行降序排序。请注意，您是在现有光标上执行这些功能的——也就是说，针对之前执行的`find()`命令的结果。

以下示例根据联系人的年龄对其进行升序排序:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find();`

`// Use the sort command to sort all results in $cursor, based on their age`

`$cursor->sort(array('Age' => 1));`

`// Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

您在实际光标上执行`limit()`函数；这总共需要一个参数，它指定了您希望返回的结果的数量。`limit()`命令返回它在集合中找到的符合搜索条件的前 n 个项目。下面的例子只返回一个文档(当然，您可以使用`findOne()`函数来代替，但是`limit()`可以完成这项工作):

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find();`

`// Use the limit function to limit the number of results to 1`

`$cursor->limit(1);`

`//Print the result`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

最后，您可以使用`skip()`函数跳过符合您的标准的前 n 个结果。该函数也适用于光标:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find();`

`// Use the skip function to skip the first result found`

`$cursor->skip(1);`

`// Print the result`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

### 统计匹配结果的数量

您可以使用 PHP 的`count()`函数来计算符合您的标准的文档数，并返回数组中的项目数。该函数是`MongoCursor`类的一部分，因此对光标进行操作。以下示例显示如何获取居住在美国的人在集合中的联系人计数:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'$collection = $c->contacts->people;`

`// Specify the search parameters`

`$country = array("Address.Country" => "USA");`

`// Execute the query and store under the $cursor variable for further processing`

`$cursor = $collection->find($country);`

`// Count the results and return the value`

`print_r($cursor->count());`

该查询返回一个结果。这种计数对于各种操作都很有用，无论是计算评论数、注册用户总数还是其他任何操作。

### 使用聚合框架对数据进行分组

聚合框架很容易成为 MongoDB 内置的更强大的特性之一，因为它允许您计算聚合值，而无需使用通常过于复杂的 Map/Reduce 功能。框架包含的最有用的管道操作符之一是`$group`操作符，它可以粗略地与 SQL 的 GROUP BY 功能相比较。该运算符允许您基于一组文档计算聚合值。比如聚合函数`$max`可以用来寻找并返回一个组的最高值；`$min`函数查找并返回最小值，而`$sum`函数计算给定值出现的总次数。

假设您想要获得您的集合中所有联系人的列表，按他们居住的国家分组。聚合框架让您可以轻松做到这一点。让我们来看一个例子:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Execute the query and store it under the $result variable`

`$result = $collection->aggregate(array(`

`'$group' => array(`

`'_id' => '$Address.Country'`，

`'total' => array('$sum' => 1)`

`)`

`));`

`// Count the results and return the value`

`print_r($result);`

如您所见，`aggregate`函数接受一个(或多个)带有管道操作符的数组(在本例中是`$group`操作符)。在这里，您可以指定如何返回结果输出，以及要执行的任何可选聚合函数:在本例中是`$sum`函数。在这个例子中，为每个找到的唯一国家返回一个唯一的文档，由文档的`_id`字段表示。接下来，使用`$sum`函数汇总每个国家的总计数，并使用`total`字段返回。注意,`$sum`函数是由一个数组表示的，给定值 1 是因为我们希望每一个匹配都将总数增加 1。

您可能想知道最终的输出会是什么样子。下面是一个输出示例，假设有两个联系人生活在英国，一个生活在美国:

`Array (`

`[result] => Array (`

`[0] => Array (`

`[_id] => UK [total] => 2`

`)`

`[1] => Array (`

`[_id] => USA [total] => 1`

`)`

`)`

`[ok] => 1`

`)`

这个例子很简单，但是聚合框架确实非常强大，当我们在第 8 章更深入地研究它时，你会看到这一点。

### 使用提示指定索引

您使用 PHP 的`hint()`函数来指定查询数据时应该使用哪个索引；这样做可以帮助您提高查询性能。例如，假设您的集合中有数千个联系人，您通常根据姓氏来搜索一个人。在这种情况下，建议您在集合中的`Last Name`键上创建一个索引。

Note

如果没有首先创建索引，接下来显示的`hint()`示例将不会返回任何内容。

要使用`hint()`函数，您必须将其应用于光标，如下例所示:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find(array("Last Name" => "Moran"));`

`// Use the hint function to specify which index to use`

`$cursor->hint(array("Last Name" => -1));`

`//Print the result`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

Note

有关如何创建索引的更多详细信息，请参见第 4 章。也可以使用 PHP 驱动程序的`ensureIndex()`函数来创建一个索引，如前所述。

### 用条件运算符细化查询

您可以使用条件运算符来优化查询。PHP 附带了一组很好的默认条件操作符，比如`<`(小于)、`>`(大于)、`<=`(小于或等于)和`>=`(大于或等于)。现在是坏消息:你不能在 PHP 驱动中使用这些操作符。相反，您将需要使用 MongoDB 版本的这些操作符。幸运的是，MongoDB 本身带有大量的条件操作符(您可以在第 4 章的[中找到关于这些操作符的更多信息)。当通过 PHP 查询数据时，可以使用所有这些操作符，通过`find()`函数传递它们。](04.html)

虽然可以在 PHP 驱动程序中使用所有这些操作符，但是必须使用特定的语法；也就是说，您必须将它们放在一个数组中，并将该数组传递给`find()`函数。下面几节将向您介绍如何使用几种常用的运算符。

#### 使用$lt、$gt、$lte 和$gte 运算符

MongoDB 的`$lt`、`$gt`、`$lte`和`$gte`操作符允许您分别执行与`<`、`>`、`<=`和`>=`操作符相同的操作。当您想要搜索存储整数值的文档时，这些运算符非常有用。

您可以使用`$lt`(小于)运算符来查找整数值小于 n 的任何类型的数据，如下例所示:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('Age' => array('$lt' => 30));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

结果输出显示当前文档中只有一个结果:维多利亚·伍德的联系信息，他刚好不到 30 岁:

`Array (`

`[_id] => MongoId Object ( )`

`[First Name] => Victoria`

`[Last Name] => Wood`

`Address] => Array (`

`[Street] => 50 Ash lane`

`[Place] => Ystradgynlais`

`[Postal Code] => SA9 6XS`

`[Country] => UK`

`)`

`[E-Mail] => Array (`

`[0] =>` `vw@example.com`

`[1] =>` `vw@office.com`

`)`

`[Phone] => 078-8727-8049`

`[Age] => 28`

`)`

同样，您可以使用`$gt`操作符来查找任何年龄超过 30 岁的联系人。下面的例子通过将变量`$lt`改为`$gt`(大于)来实现:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('Age' => array('$gt' => 30));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

这将返回 Philip Moran 的文档，因为他已经超过 30 岁了:

`Array (`

`[_id] => MongoId Object ( )`

`[First Name] => Philip`

`[Last Name] => Moran`

`[Address] => Array (`

`[Street] => 681 Hinkle Lake Road`

`[Place] => Newton`

`[Postal Code] => MA 02160`

`[Country] => USA`

`)`

`[E-Mail] => Array (`

`[0] =>` `pm40%example.com`

`[1] =>` `pm40%office.com`

`[2] =>` `philip40%example.com`

`[3] =>` `philip40%office.com`

`[4] =>` `moran40%example.com`

`[5] =>` `moran40%office.com`

`[6] =>` `pmoran40%example.com`

`[7] =>` `pmoran@office.com`

`)`

`[Phone] => 617-546-8428`

`[Age] => 60`

`)`

您可以使用`$lte`操作符来指定该值必须完全匹配或者小于指定的值。记住:`$lt`会找到任何小于 30 岁的人，但不会找到正好 30 岁的人。对于`$gte`操作符也是如此，它查找任何大于或等于指定整数的值。现在我们来看两个例子。

第一个示例将集合中的两个项目都返回到屏幕上:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('Age' => array('$lte' => 60));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

第二个示例将只显示一个文档，因为该集合只包含一个 60 岁或以上的联系人:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('Age' => array('$gte' => 60));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

#### 查找与值不匹配的文档

您可以使用`$ne`(不等于)运算符来查找任何与`$ne`运算符中指定的值不匹配的文档。这个操作符的语法很简单。下一个示例将显示年龄不等于 28 岁的任何联系人:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('Age' => array('$ne' => 28));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

#### 匹配多个值中的任何一个

`$in`操作符允许您搜索与添加到数组中的几个可能值相匹配的文档，如下例所示:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('Address.Country' => array('$in' => array("USA","UK")));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

结果输出将显示您添加的任何人的任何联系信息，无论此人居住在美国还是英国。注意，可能性列表实际上是添加在一个数组中的；它不能以“就这样”的形式键入。

#### 用$all 匹配查询中的所有标准

像`$in`操作符一样，`$all`操作符允许您比较一个附加数组中的多个值。不同之处在于,`$all`操作符要求数组中的所有项都匹配一个文档，然后它才返回任何结果。以下示例显示了如何进行这样的查询:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('E-Mail' => array('$all' => array("``vw@example.com``","``vw@office.com`T4】

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

#### 使用$或搜索多个表达式

您可以使用`$or`操作符来指定一个文档可以包含的多个表达式，以返回一个匹配。这两个操作符的区别在于,`$in`操作符不允许你同时指定键和值，而`$or`操作符允许。您可以将`$or`操作符与任何其他键/值组合结合使用。我们来看两个例子。

第一个示例搜索并返回任何包含整数值为`28`的`Age`键或值为`USA`的`Address.Country`键的文档:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('$or' => array(`

`array("Age" => 28)`，

`array("Address.Country" => "USA")`

`) );`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

第二个示例搜索并返回任何将`Address.Country`键设置为`USA`(强制)，以及将键/值设置为`"Last Name" : "Moran"`或`"E-Mail" : "` `vw@example.com` `"`的文档:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array(`

`"Address.Country" => "USA"`，

`'$or' => array(`

`array("Last Name" => "Moran")`，

`array("E-Mail" => "``vw40%example.com`T2】

`)`

`);`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

`$or`操作符允许您一次进行两个搜索，然后合并结果输出，即使这两个搜索没有任何共同点。

#### 使用$slice 检索指定数量的项目

您可以使用`$slice`投影操作符从文档的数组中检索指定数量的项目。该功能类似于本章前面详述的`skip()`和`limit()`功能。不同之处在于，`skip()`和`limit()`函数处理整个文档，而`$slice`操作符允许您处理一个数组而不是单个文档。

投影操作符是限制每页项目数量的一个很好的方法(这就是通常所说的分页)。下一个示例显示了如何限制从前面指定的联系人之一(Philip Moran)返回的电子邮件地址的数量；在这种情况下，您只需返回前三个电子邮件地址:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify our search operator`

`$query = array("Last Name" => "Moran");`

`// Create a new object from an array using the $slice operator`

`$cond = (object)array('E-Mail' => array('$slice' => 3));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($query, $cond);`

`// For each document it finds within the collection, print the contents`

`while ($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

同样，通过将整数设为负数，您只能获得列表中最后三个电子邮件地址，如下例所示:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify our search operator`

`$query = array("Last Name" => "Moran");`

`// Specify the conditional operator`

`$cond = (object)array('E-Mail' => array('$slice' => -3));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($query, $cond);`

`// For each document it finds within the collection, print the contents`

`while ($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

或者，您可以跳过前两个条目，将结果限制为三个:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify our search operator`

`$query = array("Last Name" => "Moran");`

`// Specify the conditional operator`

`$cond = (object)array('E-Mail' => array('$slice' => array(2, 3)));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($query, $cond);`

`// For each document it finds within the collection, print the contents`

`while ($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

`$slice`操作符是限制数组中项目数量的好方法；在使用 MongoDB 驱动程序和 PHP 编程时，您肯定希望记住这个操作符。

#### 确定字段是否有值

您可以使用`$exists`操作符返回一个基于字段是否有值的结果(不管这个字段的值是多少)。这听起来可能不合逻辑，但实际上非常方便。例如，您可以搜索尚未设置`Age`字段的联系人；或者，您可以搜索有街道名称的联系人。

以下示例返回没有设置`Age`字段的所有联系人:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array('Age' => array('$exists' => false));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

类似地，下一个示例返回设置了`Street`字段的所有联系人:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the conditional operator`

`$cond = array("Address.Street" => array('$exists' => true));`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find($cond);`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

### 正则表达式

正则表达式很整洁。你可以用它们做任何事情(也许除了煮咖啡)；在搜索数据时，它们可以极大地简化您的生活。PHP 驱动自带了自己的正则表达式类:`MongoRegex`类。您可以使用这个类来创建正则表达式，然后使用它们来查找数据。

`MongoRegex`类知道六个正则表达式标志，您可以用它们来查询您的数据。你可能已经熟悉其中的一些:

*   `i`:触发不区分大小写。
*   `m`:搜索跨多行(换行符)的内容。
*   `x`:允许您的搜索包含#条评论。
*   `l`:指定语言环境。
*   `s`:又称 dotall，“”可以指定为匹配所有内容，包括新行。
*   `u`:匹配 Unicode。

现在让我们仔细看看如何在 PHP 中使用正则表达式来搜索集合中的数据。显然，这最好用一个简单的例子来说明。

例如，假设您想搜索一个信息很少的联系人。例如，你可能会模糊地回忆起这个人居住的地方，并且在中间的某个地方包含了类似 stradgynl 的东西。正则表达式为您提供了一种简单而优雅的方法来搜索这样的人:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the regular expression`

`$regex = new MongoRegex("/stradgynl/i");`

`// Execute the query and store it under the $cursor variable`

`$cursor = $collection->find(array("Address.Place" => $regex));`

`//Print the results`

`while($document = $cursor->getNext())`

`{`

`print_r($document);`

`}`

当创建一个 PHP 应用时，您通常希望搜索特定的数据。在前面的例子中，您可能会用一个`$_POST`变量替换文本(本例中为`"stradgynl"`)。

## 用 PHP 修改数据

如果我们生活在一个所有数据都保持静态、人类从不犯任何打字错误的世界，我们就永远不需要更新我们的文档。但是这个世界比这要灵活一点，有时候我们会犯一些我们想要改正的错误。

对于这种情况，您可以在 MongoDB 中使用一组修饰符函数来更新(并因此更改)您现有的数据。你可以用几种方法做到这一点。例如，您可以使用`update()`函数更新现有信息，然后使用`save()`函数保存您的更改。接下来的几节将研究这些和其他修饰运算符，并说明如何有效地使用它们。

### 通过 update()更新

正如在[第 4 章](04.html)中所详述的，您使用`update()`功能来执行大多数文档更新。与 MongoDB shell 中的`update()`版本一样，PHP 驱动程序附带的`update()`函数允许您使用各种修改符操作符来快速轻松地更新您的文档。PHP 版本的`update()`函数的操作几乎相同；然而，成功地使用 PHP 版本需要一种非常不同的方法。下一节将向您介绍如何在 PHP 中成功使用该函数。

PHP 的`update()`函数至少有两个参数:第一个描述要更新的对象，第二个描述要更新匹配记录的对象。此外，您可以为扩展的选项集指定第三个参数。

`options`参数提供了七个额外的标志，可以与`update()`函数一起使用；以下列表解释了它们是什么以及如何使用它们:

*   `upsert`:如果设置为`true`，如果搜索标准不匹配，该布尔选项将创建一个新文档。
*   `multiple`:如果设置为`true`，该布尔选项将更新所有符合搜索条件的文档。
*   `fsync`:如果设置为`true`，该布尔选项会在返回成功之前将数据同步到磁盘。如果该选项被设置为`true`，则意味着`w`被设置为`0`，即使它没有被设置。默认为 false。
*   `w`:如果设置为 0，更新操作将不被确认。使用副本集时，`w`也可以设置为 n，确保主服务器在成功复制到 n 个节点时确认更新操作。也可以设置为`'majority'`—一个保留字符串，以确保大多数副本节点将确认更新，或者设置为特定的标签，以确保那些被标记的节点将确认更新。该选项默认为 1，表示确认更新操作。
*   `j`:如果设置为`true`，该布尔选项将在指示更新成功之前强制将数据写入日志。默认为`false`。
*   `wtimeout`:用于指定服务器等待接收确认的时间(毫秒)。默认为 10000。
*   `timeout`:用于指定客户端需要等待数据库响应的时间(毫秒)。

现在让我们来看一个普通的例子，它在不使用任何修饰运算符的情况下将维多利亚·伍德的名字改为“Vicky”(稍后将讨论这些运算符):

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Last Name" => "Wood");`

`// Specify the information to be changed`

`$update = array(`

`"First Name" => "Vicky"`，

`"Last Name" => "Wood"`，

`"Address" => array(`

`"Street" => "50 Ash lane"`，

`"Place" => "Ystradgynlais"`，

`"Postal Code" => "SA9 6XS"`，

`"Country" => "UK"`

`)`

,

`"E-Mail" => array(`

`"` `vw40%example.com` `"`，

`"``vw40%office.com`T2】

`)`，

`"Phone" => "078-8727-8049"`，

`"Age" => 28`

`);`

`// Options`

`$options = array("upsert" => true);`

`// Perform the update`

`$collection->update($criteria,$update,$options);`

`// Show the result`

`print_r($collection->findOne($criteria));`

结果输出如下所示:

`Array (`

`[_id] => MongoId Object ()`

`[First Name] => Vicky`

`[Last Name] => Wood`

`[Address] => Array (`

`[Street] => 50 Ash lane`

`[Place] => Ystradgynlais`

`[Postal Code] => SA9 6XS`

`[Country] => UK`

`)`

`[E-Mail] => Array (`

`[0] =>` `vw40%example.com`

`[1] =>` `vw40%office.com`

`)`

`[Phone] => 078-8727-8049`

`[Age] => 28`

`)`

仅仅改变一个价值观就要做很多工作——这并不完全是你想要谋生的方式。然而，如果不使用 PHP 的修饰符操作符，这恰恰是您必须要做的。现在让我们来看看如何在 PHP 中使用这些操作符来使生活变得更简单，消耗更少的时间。

Warning

如果在应用更改时没有指定任何条件运算符，匹配文档中的数据将被数组中的信息替换。一般来说，如果你只想改变一个字段，最好使用`$set`。

### 使用更新运算符节省时间

更新操作将为您节省大量的输入。你可能会同意，前面的例子是不可行的。幸运的是，PHP 驱动程序包含了大约六个更新操作符，用于快速修改数据，而无需麻烦地将数据全部写出来。每个操作符的用途将再次简要总结，尽管此时您可能已经熟悉了其中的大部分(您可以在第 4 章的[中找到本节讨论的所有更新操作符的更多信息)。然而，在 PHP 中使用它们的方式有很大的不同，与它们相关的选项也是如此。我们将查看每个操作符的例子，尤其是为了让您熟悉它们在 PHP 中的语法。](04.html)

Note

后面的更新操作符都不会包含 PHP 代码来检查所做的更改；相反，下面的例子只是应用了这些变化。建议您在 PHP 代码旁边启动 MongoDB shell，这样您就可以执行搜索并确认所需的更改已经应用。或者，您可以编写额外的 PHP 代码来执行这些检查。

#### 用$inc 增加特定键的值

`$inc`操作符允许您将特定键的值增加 n，假设该键存在。如果该键不存在，将会创建一个。以下示例将 40 岁以下的每个人的年龄增加三岁:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Search for anyone that's younger than 40`

`$criteria = array("Age" => array('$lt' => 40));`

`// Use $inc to increase their age by 3 years`

`$update = array('$inc' => array('Age' => 3));`

`// Options`

`$options = array("upsert" => true);`

`// Perform the update`

`$collection->update($criteria,$update,$options);`

#### 用$set 更改键值

`$set`操作符允许您在忽略任何其他字段的同时更改键值。如前所述，在前面的例子中，这是将 Victoria 的名字更新为`"Vicky"`的更好的选择。下面的例子展示了如何使用`$set`操作符将联系人的名字改为`"Vicky"`:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Last Name" => "Wood");`

`// Specify the information to be changed`

`$update = array('$set' => array("First Name" => "Vicky"));`

`// Options`

`$options = array("upsert" => true);`

`// Perform the update`

`$collection->update($criteria,$update,$options);`

您还可以使用`$set`为匹配您的查询的每个匹配项添加一个字段:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria using regular expressions`

`$criteria = array("E-Mail" => new MongoRegex("``/40%office.com/i`T2】

`// Add "Category => Work" into every occurrence found`

`$update = array('$set' => array('Category' => 'Work'));`

`// Options`

`$options = array('upsert' => true, 'multi' => true);`

`// Perform the upsert via save()`

`$collection->update($criteria,$update,$options);`

#### 删除未设置$的字段

`$unset`操作符的工作方式类似于`$set`操作符。不同之处在于,`$unset`让您从文档中删除给定的字段。例如，以下示例从维多利亚·伍德的联系人信息中删除了`Phone`字段及其相关数据:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Last Name" => "Wood");`

`// Specify the information to be removed`

`$update = array('$unset' => array("Phone" => 1));`

`// Perform the update`

`$collection->update($criteria,$update);`

#### 用$rename 重命名字段

`$rename`操作符可用于重命名字段。当你不小心打错了或者只是想把它的名字改成一个更准确的名字时，这很有帮助。操作符将在每个文档及其底层数组和子文档中搜索给定的字段名。

Warning

使用该运算符时要小心。如果文档已经包含具有新名称的字段，该字段将被删除，之后旧的字段名将被重命名为指定的新名称。

让我们看一个例子，对于 Vicky Wood 来说，`First Name`和`Last Name`字段将分别被重命名为`Given Name`和`Family Name`:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Last Name" => "Wood");`

`// Specify the information to be changed`

`$update = array('$rename' => array("First Name" => "Given Name", "Last Name" => "Family Name"));`

`// Perform the update`

`$collection->update($criteria,$update);`

#### 使用$setOnInsert 在 Upsert 期间更改键值

PHP 的`$setOnInsert`操作符仅在 update 函数在使用 upsert 操作符时执行 insert 操作的情况下才可用于指定特定值。起初这可能听起来有点混乱，但是您可以将这个操作符看作一个条件语句，它只在`upsert`插入文档时设置给定值，而不是更新文档。让我们看一个例子来阐明这是如何工作的。首先，我们将执行一个匹配现有文档的 upsert，从而忽略指定的`$setOnInsert`标准:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wood");`

`// Specify the information to be set on upsert-inserts only`

`$update = array('$setOnInsert' => array("Country" => "Unknown"));`

`// Specify the upsert options`

`$options = array("upsert" => true);`

`// Perform the update`

`$collection->update($criteria,$update,$options);`

接下来，让我们看一个例子，当文档尚不存在时，upsert 执行插入。在这里，您会发现给出的`$setOnInsert`标准将被成功应用:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wallace");`

`// Specify the information to be set on upsert-inserts only`

`$update = array('$setOnInsert' => array("Country" => "Unknown"));`

`// Specify the upsert options`

`$options = array("upsert" => true);`

`// Perform the update`

`$collection->update($criteria,$update,$options);`

这段代码将搜索任何将`Family Name`-字段(记得我们之前将其重命名)设置为`"Wallace"`的文档。如果找不到，将进行一次 upsert，结果是`Country`字段将被设置为`"Unknown"`，创建如下看起来空白的文档:

`{`

`"_id" : ObjectId("1")`，

`"Country" : "Unknown"`，

`"Last Name" : "Wallace"`

`}`

#### 用$push 将值追加到指定的字段

PHP 的`$push`操作符允许您将一个值添加到指定的字段中。如果字段是现有数组，将添加数据；如果该字段不存在，将会创建它。如果该字段存在，但它不是一个数组，那么将引发一个错误条件。下面的例子展示了如何使用`$push`将一些数据添加到现有的数组中:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wood");`

`// Specify the information to be added`

`$update = array('$push' => array("E-Mail" => "vw40%mongo.db"));`

`// Perform the update`

`$collection->update($criteria,$update);`

#### 用$push 和$each 向一个键添加多个值

`$push`操作符还允许您向一个键追加多个值。为此，需要添加`$each`修饰符。如果给定字段中不存在数组中的值，则将添加这些值。由于使用了`$push`操作符，同样的一般规则也适用:如果字段存在，并且它是一个数组，那么数据将被添加；如果它不存在，那么它将被创建；如果它存在，但它不是一个数组，那么将引发一个错误条件。以下示例说明了如何使用`$each`修改器:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wood");`

`// Specify the information to be added`

`$update = array(`

`'$push' => array(`

`"E-Mail" => array(`

`'$each' => array(`

`"vicwo40%mongo.db"`，

`"``vicwo40%example.com`T2】

`)`

`)`

`)`

`);`

`// Perform the update`

`$collection->update($criteria,$update);`

#### 用$addToSet 向数组中添加数据

`$addToSet`操作符类似于`$push`操作符，有一个重要的区别:`$addToSet`确保只有当数据不在数组中时，才将数据添加到数组中。`$addToSet`运算符将一个数组作为参数:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wood");`

`// Specify the information to be added (successful because it doesn't exist yet)`

`$update = array('$addToSet' => array("E-Mail" => "``vic40%example.com`T2】

`// Perform the update`

`$collection->update($criteria,$update);`

类似地，您可以通过组合`$addToSet`操作符和`$each`操作符来添加一些尚不存在的项目:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wood");`

`// Specify the information to be added (partially successful; some`

`// examples were already there)`

`$update = array(`

`'$addToSet' => array`

`(`

`"E-Mail" => array`

`(`

`'$each' => array`

`(`

`"vw40%mongo.db"`，

`"vicky40%mongo.db"`，

`"``vicky40%example.com`T2】

`)`

`)`

`)`

`);`

`// Perform the update`

`$collection->update($criteria,$update);`

#### 用$pop 从数组中移除元素

PHP 的`$pop`操作符允许你从数组中移除一个元素。请记住，您只能删除数组中的第一个或最后一个元素，而不能删除中间的任何元素。您通过指定值`-1`来删除第一个元素；类似地，通过指定`1`的值来删除最后一个元素:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wood");`

`// Pop out the first e-mail address found in the list`

`$update = array('$pop' => array("E-Mail" => -1));`

`// Perform the update`

`$collection->update($criteria,$update);`

Note

指定值`-2`或`1000`不会改变删除哪个元素。任何负数都将删除第一个元素，而任何正数都将删除最后一个元素。使用值`0`从数组中删除最后一个元素。

#### 使用$pull 删除每个值

您可以使用 PHP 的`$pull`操作符从数组中删除给定值的每一次出现。例如，如果您在使用`$push`或`$pushAll`时不小心将副本添加到数组中，这就很方便了。以下示例删除电子邮件地址的任何重复项:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wood");`

`// Pull out each occurrence of the e-mail address "``vicky40%example.com`T2】

`$update = array('$pull' => array("E-Mail" => "``vicky40%example.com`T2】

`// Perform the update`

`$collection->update($criteria,$update);`

#### 移除多个元素的每个匹配项

类似地，您可以使用`$pullAll`操作符从文档中删除多个元素的每次出现，如下例所示:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wood");`

`// Pull out each occurrence of the e-mail addresses below`

`$update = array(`

`'$pullAll' => array(`

`"E-Mail" => array("vw40%mongo.db","``vw40%office.com`T2】

`)`

`);`

`// Perform the update`

`$collection->update($criteria,$update);`

### 使用 save()更新数据

像`insert()`函数一样，`save()`函数允许您将数据插入到集合中。唯一的区别是，您还可以使用`save()`来更新已经保存数据的字段。您可能还记得，这被称为 upsert。在这一点上，您执行`save()`函数的方式不应该令人惊讶。像 MongoDB shell 中的`save()`函数一样，PHP 的`save()`接受两个参数:一个包含您希望保存的信息的数组，以及任何保存选项。可以使用以下选项:

*   `fsync`:如果设置为`true`，该布尔选项会在返回成功之前将数据同步到磁盘。如果该选项被设置为`true`，则意味着`w`被设置为`0`，即使它没有被设置。
*   `w`:如果设置为 0，保存操作将不被确认。使用副本集时，w 也可以设置为 n，以确保主服务器在成功复制到 n 个节点时确认保存操作。也可以设置为`'majority'`—一个保留字符串，以确保大多数副本节点将确认保存，或者设置为特定标记，以确保标记的那些节点将确认保存。该选项默认为 1，表示确认保存操作。
*   `j`:如果设置为 true，此布尔选项将在指示保存成功之前强制将数据写入日志。默认为 false。
*   `wtimeout`:用于指定服务器等待接收确认的时间(毫秒)。默认为 10000。
*   `timeout`:用于指定客户端需要等待数据库响应的时间(毫秒)。

PHP 的`save()`版本的语法类似于 MongoDB shell 中的语法，如下例所示:

`// Specify the document to be saved`

`$contact = array(`

`"Given Name" => "Kenji"`，

`"Family Name" => "Kitahara"`，

`"Address" => array(`

`"Street" => "149 Bartlett Avenue"`，

`"Place" => "Southfield"`，

`"Postal Code" => "MI 48075"`，

`"Country" => "USA"`

`)`

,

`"E-Mail" => array(`

`"` `kk40%example.com` `"`，

`"``kk40%office.com`T2】

`)`，

`"Phone" => "248-510-1562"`，

`"Age" => 34`

`);`

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people'`

`$collection = $c->contacts->people;`

`// Save via the save() function`

`$options = array("fsync" => true);`

`// Specify the save() options`

`$collection->save($contact,$options);`

`// Realizing you forgot something, let's upsert this contact:`

`$contact['Category'] = 'Work';`

`// Perform the upsert`

`$collection->save($contact);`

### 原子地修改文档

像`save()`和`update()`函数一样，`findAndModify()`函数可以从 PHP 驱动程序中调用。请记住，您可以使用`findAndModify()`函数自动修改文档，并在更新成功执行后返回结果。您使用`findAndModify()`函数来更新单个文档——仅此而已。您可能还记得，默认情况下，返回的文档不会显示所做的修改——返回包含所做修改的文档需要指定一个额外的参数:参数`new`。

`findAndModify`函数有四个参数；`query`、`update`、`fields`、`options`。其中一些是可选的，取决于您的操作。例如，当指定`update`标准时，字段和选项是可选的。然而，当您希望使用`remove`选项时，需要指定`update`和`fields`参数(例如，使用`null`)。以下列表详细列出了可用的参数:

*   `query`:指定查询的过滤器。如果没有指定这个参数，那么集合中的所有文档都将被视为可能的候选文档，遇到的第一个文档将被更新或删除。
*   `update`:指定更新文档的信息。请注意，前面指定的任何修饰运算符都可以用来实现这一点。
*   `fields`:指定您希望看到返回的字段，而不是整个文档。该参数的行为与`find()`功能中的`fields`参数相同。请注意，`_id`字段将总是被返回，即使该字段不在您要返回的字段列表中。
*   `options`:指定要应用的选项。可以使用以下选项:
    *   `sort`:按照指定的顺序对匹配的文档进行排序。
    *   `remove`:如果设置为`true`，将删除第一个匹配的文档。
    *   `update`:如果设置为`true`，将对选择的文档进行更新。
    *   `new`:如果设置为`true`，则返回更新的文档，而不是选择的文档。注意，这个参数不是默认设置的，这在某些情况下可能会有点混乱。
    *   `upsert`:如果设置为`true`，则执行一次上插。

现在让我们来看一组说明如何使用这些参数的例子。第一个示例搜索姓氏为`"Kitahara"`的联系人，并通过将`update()`和`$push`操作符结合起来，将一个电子邮件地址添加到他的联系人卡片中。在下面的例子中没有设置`new`参数，所以结果输出仍然显示旧的信息:

`// Connect to the database`

`$c = new MongoClient();`

`// Specify the database and collection in which to work`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Kitahara");`

`// Specify the update criteria`

`$update = array('$push' => array("E-Mail" => "kitahara40%mongo.db"));`

`// Perform a findAndModify()`

`$collection->findAndModify($criteria,$update);`

返回的结果如下所示:

`Array (`

`[value] => Array (`

`[Given Name] => Kenji`

`[Family Name] => Kitahara`

`[Address] => Array (`

`[Street] => 149 Bartlett Avenue`

`[Place] => Southfield`

`[Postal Code] => MI 48075`

`[Country] => USA`

`)`

`[E-Mail] => Array (`

`[0] =>` `kk40%example.com`

`[1] =>` `kk40%office.com`

`)`

`[Phone] => 248-510-1562`

`[Age] => 34`

`[_id] => MongoId Object ( )`

`[Category] => Work`

`)`

`[ok] => 1`

`)`

以下示例显示了如何使用`remove`和`sort`参数:

`// Connect to the database`

`$c = new MongoClient();`

`// Specify the database and collection in which to work`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Category" => "Work");`

`// Specify the options`

`$options = array("sort" => array("Age" => -1), "remove" => true);`

`// Perform a findAndModify()`

`$collection->findAndModify($criteria,null,null,$options);`

## 删除数据

您可以使用`remove()`函数从 MongoDB shell 中删除一个文档，就像前面例子中的文档一样。PHP 驱动程序还包括一个`remove()`函数，可以用来删除数据。这个函数的 PHP 版本有两个参数:一个包含要删除的记录的描述，另一个指定管理删除过程的附加选项。

有七个选项可供选择:

*   `justOne`:如果设置为 true，则最多只能删除一条符合条件的记录。
*   `fsync`:如果设置为`true`，该布尔选项会在返回成功之前将数据同步到磁盘。如果该选项被设置为`true`，则意味着`w`被设置为`0`，即使它没有被设置。
*   `w`:如果设置为 0，保存操作将不被确认。使用副本集时，w 也可以设置为 n，以确保主服务器在成功复制到 n 个节点时确认保存操作。也可以设置为`'majority'`—一个保留字符串，以确保大多数副本节点将确认保存，或者设置为特定的标记，以确保那些标记的节点将确认保存。该选项默认为 1，表示确认保存操作。
*   `j`:如果设置为 true，此布尔选项将在指示保存成功之前强制将数据写入日志。默认为 false。
*   `wtimeout`:用于指定服务器等待接收确认的时间(毫秒)。默认为 10000。
*   `timeout`:用于指定客户端需要等待数据库响应的时间(毫秒)。

现在让我们来看几个说明如何移除文档的代码示例:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria`

`$criteria = array("Family Name" => "Wallace");`

`// Specify the options`

`$options = array('justOne' => true, 'w' => 0);`

`// Perform the removal`

`$collection->remove($criteria,$options);`

同样，下一个示例同时删除多个文档:

`// Connect to the database`

`$c = new Mongo();`

`// Select the collection 'people' from the database 'contacts'`

`$collection = $c->contacts->people;`

`// Specify the search criteria using regular expressions`

`$criteria = array("E-Mail" => new MongoRegex("``/40%office.com/i`T2】

`// Specify the options`

`$options = array("justOne" => false);`

`// Perform the removal`

`$collection->remove($criteria,$options);`

Warning

当您删除文档时，请记住对该文档的任何引用都将保留在数据库中。请确保您也手动删除或更新对已删除文档的引用；否则，这些引用在求值时将返回`null`。

类似地，您可以使用`drop()`函数删除整个集合。以下示例返回包含删除结果的数组:

`// Connect to the database`

`$c = new Mongo();`

`// Select the collection to remove`

`$collection = $c->contacts->people;`

`// Remove the collection and return the results`

`print_r($collection->drop());`

返回的结果如下所示:

`Array (`

`[nIndexesWas] => 1`

`[msg] => indexes dropped for collection`

`[ns] => contacts.people`

`[ok] => 1`

`)`

最后但同样重要的是，您可以使用 PHP 删除整个数据库。您可以通过使用`MongoDB`类中的`drop()`函数来实现这一点，如下例所示:

`// Connect to the database`

`$c = new Mongo();`

`// Select the database to remove`

`$db = $c->contacts;`

`// Remove the database and return the results`

`print_r($db->drop());`

返回的结果显示被删除的数据库的名称:

`Array (`

`[dropped] => contacts`

`[ok] => 1`

`)`

## 其他序列库的有关记录

DBRef 使您能够在存储在不同位置的两个文档之间创建链接；该功能允许您实现类似于关系数据库中的行为。如果您想将来自这些人的地址存储在一个`addresses`集合中，而不是将这些信息包含在您的`people`集合中，这个功能会非常方便。

有两种方法可以做到这一点。首先，您可以使用一个简单的链接(称为手动引用)；在这种情况下，您将一个文档的`_id`包含到另一个文档中。其次，可以使用 DBRef 自动创建这样的链接。

首先，让我们看看如何实现手动引用。在以下示例中，您添加了一个联系人，并在其地址信息下指定了另一个文档的`_id`:

`// Connect to the database`

`$c = new MongoClient();`

`$db = $c->contacts;`

`// Select the collections we want to store our contacts and addresses in`

`$people = $db->people;`

`$addresses = $db->addresses;`

`// Specify an address`

`$address = array(`

`"Street" => "St. Annastraat 44"`，

`"Place" => "Monster"`，

`"Postal Code" => "2681 SR"`，

`"Country" => "Netherlands"`

`);`

`// Save the address`

`$addresses->insert($address);`

`// Add a contact living at the address`

`$contact = array(`

`"First Name" => "Melvyn"`，

`"Last Name" => "Babel"`，

`"Age" => 35`，

`"Address" => $address['_id']`

`);`

`$people->insert($contact);`

现在假设您想要查找前面的联系人的地址信息。为此，只需在`address`字段中查询`Object ID`;你可以在`addresses`收藏中找到这个信息(假设你知道这个收藏的名字)。

这是可行的，但是引用另一个文档的首选方法依赖于 DBRef。这是因为 DBRef 依赖于数据库和所有驱动程序都理解的通用格式。我们马上会看到前面例子的 DBRef 版本。不过，在这样做之前，我们先来看看`DBRef`类的`create()`函数；您将使用该类来创建所需的引用。

`create()`函数有三个参数:

*   `collection`:指定信息所在集合的名称(不含数据库名称)。
*   `id`:指定要链接的文档的 ID。
*   `database`:指定文档所在数据库的名称。

以下示例使用`create()`函数创建对另一个文档中地址的引用:

`// Connect to the database`

`$c = new Mongo();`

`$db = $c->contacts;`

`// Select the collections we want to store our contacts and addresses in`

`$people = $db->people;`

`$addresses = $db->addresses;`

`// Specify an address`

`$address = array(`

`"Street" => "WA Visser het Hooftlaan 2621"`，

`"Place" => "Driebergen"`，

`"Postal Code" => "3972 SR"`，

`"Country" => "Netherlands"`

`);`

`// Save the address`

`$addresses->insert($address);`

`// Create a reference to the address`

`$addressRef = MongoDBRef::create($addresses->getName(), $address['_id']);`

`// Add a contact living at the address`

`$contact = array(`

`"First Name" => "Ivo"`，

`"Last Name" => "Lauw"`，

`"Age" => 24`，

`"Address" => $addressRef`

`);`

`$people->insert($contact);`

Note

本例中的`getName()`函数用于获取集合的名称。

### 检索信息

到目前为止，您已经使用 DBRef 创建了一个引用。现在是时候看看如何检索引用的信息了，这样您就可以再次正确地显示内容。使用 MongoDBRef 的`get()`函数可以做到这一点。

MongoDBRef 的`get()`函数有两个参数。第一个参数指定要使用的数据库，而第二个参数提供要提取的引用:

`// Connect to the database`

`$c = new Mongo();`

`// Select the collection 'people' from the database 'contacts'`

`$people = $c->contacts->people;`

`// Define the search parameters`

`$lastname = array("Last Name" => "Lauw");`

`// Find our contact, and store under the $person variable`

`$person = $people->findOne(array("Last Name" => "Lauw"));`

`// Dereference the address`

`$address = MongoDBRef::get($people->db, $person['Address']);`

`// Print out the address from the matching contact`

`print_r($address);`

结果输出显示了被引用的文档:

`Array (`

`[_id] => MongoId Object ( )`

`[Street] => WA Visser het Hooftlaan 2621`

`[Place] => Driebergen`

`[Postal Code] => 3972 SR`

`[Country] => Netherlands`

`)`

DBRef 提供了一种很好的方式来存储您想要引用的数据，尤其是因为它允许集合和数据库名称的灵活性。

## GridFS 和 PHP 驱动程序

前一章详细介绍了 GridFS 及其优点。例如，除了其他与 GridFS 相关的技术之外，它还解释了如何使用这种技术来存储和检索数据。在本节中，您将学习如何使用 PHP 驱动程序通过 GridFS 存储和检索文件。

PHP 驱动程序包含自己的处理 GridFS 的类；下面是三个最重要的类及其作用:

*   `MongoGridFS`:从数据库中存储和检索文件。这个类包含几个方法，包括`delete()`、`find()`、`storeUpload()`和大约六个其他方法。
*   `MongoGridFSFile`:作用于数据库中的特定文件。包括`__construct()`、`getFilename()`、`getSize()`、`write()`等功能。
*   `MongoGridFSCursor`:作用于光标。它包含了一些功能，如`__construct()`、`current()`、`getNext()`和`key()`。

让我们看看如何使用 PHP 将文件上传到数据库中。

Note

如果没有上载数据的 HTML 表单，下面示例中的代码将无法运行。然而，这样的代码超出了本章的范围，所以这里没有给出。

### 存储文件

使用 GridFS 使用`storeUpload()`函数将文件存储到数据库中。这个函数有两个参数:一个表示要上传的文件的字段名，另一个可选地用于指定文件的元数据。一旦使用，该函数将报告存储文件的`_id`。

以下简单的代码示例显示了如何使用`storeUpload()`函数:

`// Connect to the database`

`$c = new MongoClient();`

`// Select the name of the database`

`$db = $c->contacts;`

`// Define the GridFS class to ensure we can handle the files`

`$gridFS = $db->getGridFS();`

`// Specify the HTML field's name attribute`

`$file = 'fileField';`

`// Specify the file's metadata (optional)`

`$metadata = array('uploadDate' => date());`

`// Upload the file into the database`

`$id = $gridFS->storeUpload($file,$metadata);`

这就是全部了。正如你所看到的，`$id`被用作参数来存储数据库中的文件。您也可以使用此参数通过 DBRef 引用数据。

### 向存储的文件添加更多元数据

有时，您可能想要向存储的文件中添加更多元数据。默认情况下，添加的唯一其他数据是`_id`字段，当您将图片存储到联系人卡片时，可能会使用该字段来引用数据。不幸的是，当您想开始通过这些标签搜索数据时，这可能会被证明是一种限制而不是一种好处。

以下示例显示了如何存储上传数据的元数据。这个例子建立在前面的代码块之上，特别是参数`$id`。显然，您可以使用任何其他所需的搜索标准自行定制:

`// Specify the metadata to be added`

`$metadata = array('$set' => array("Tag" => "Avatar"));`

`// Specify the search criteria to which to apply the metadata`

`$criteria = array('_id' => $id);`

`// Insert the metadata`

`$db->grid->update($criteria, $metadata);`

### 正在检索文件

当然，如果您以后不能检索这些文件，那么将文件存储在数据库中的能力对您没有任何好处。检索文件几乎一样困难(阅读:容易！)存储它们。让我们看两个例子:第一个检索存储的文件名，而第二个检索文件本身。

以下示例显示了如何检索存储的文件名，这是使用`getFilename()`函数完成的:

`// Connect to the database`

`$c = new MongoClient();`

`$db = $c->contacts;`

`// Initialize GridFS`

`$gridFS = $db->getGridFS();`

`// Find all files in the GridFS storage and store under the $cursor parameter`

`$cursor = $gridFS->find();`

`// Return all the names of the files`

`foreach ($cursor as $object) {`

`echo "Filename:".$object->getFilename();`

`}`

那很容易！当然，这个例子假设您的数据库中存储了一些数据。在添加了一点数据之后，或者如果您想要搜索更具体的数据，您可能还想向`find()`函数添加更多的搜索参数。请注意，`find()`函数搜索添加到每个上传文件的元数据(如本章前面所述)。

您可能想知道如何检索文件本身。毕竟，检索数据可能是您最终使用最多的东西。您可以通过使用`getBytes()`函数将它发送到您的浏览器来实现这一点。下一个例子使用`getBytes()`函数来检索先前存储的图像。注意，您可以通过查询数据库来检索`_id`参数(下面的示例只是虚构了一些参数)。此外，必须指定内容类型，因为从逻辑上讲，当您再次构建数据时，浏览器不会识别内容类型:

`// Connect to the database`

`$c = new MongoClient();`

`// Specify the database name`

`$db = $c->contacts;`

`// Initialize the GridFS files collection`

`$gridFS = $db->getGridFS();`

`// Specify the search parameter for the file`

`$id = new MongoId('4c555c70be90968001080000');`

`// Retrieve the file`

`$file = $gridFS->findOne(array('_id' => $id));`

`// Specify the header for the file and write the data to it`

`header('Content-Type: image/jpeg');`

`echo $file->getBytes();`

`exit;`

### 删除数据

您可以使用`delete()`功能确保删除任何先前存储的数据。这个函数有一个参数:文件本身的`_id`。下面的例子说明了如何使用`delete()`函数删除匹配对象 ID 4c555c70be90968001080000 的文件:

`// Connect to the database`

`$c = new MongoClient();`

`// Specify the database name`

`$db = $c->contacts;`

`// Initialize GridFS`

`$gridFS = $db->getGridFS();`

`// Specify the file via it's ID`

`$id = new MongoId('4c555c70be90968001080000');`

`$file = $gridFS->findOne(array('_id' => $id));`

`// Remove the file using the remove() function`

`$gridFS->delete($id);`

## 摘要

在本章中，您已经深入了解了如何使用 MongoDB 的 PHP 驱动程序。例如，您已经看到了如何在 PHP 驱动程序中使用最常用的函数，包括`insert()`、`update()`和`modify()`函数。您还学习了如何通过使用 PHP 驱动程序的`find()`函数来搜索文档。最后，您学习了如何利用 DBRef 的功能，以及如何使用 GridFS 存储和检索文件。

一章不可能涵盖关于使用 MongoDB PHP 驱动程序的所有知识；尽管如此，这一章应该提供必要的基础知识来执行你想用这个驱动程序完成的大多数操作。在这一过程中，您还学会了在事情变得稍微复杂一点的时候使用服务器端命令。

在下一章中，你将探索相同的概念，但是对于 Python 驱动程序。